

<!DOCTYPE html>
<html lang="zh-Hans" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/pisanbao.jpg">
  <link rel="icon" href="/img/pisanbao.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="皮三宝">
  <meta name="keywords" content="">
  
    <meta name="description" content="读书笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="windows10 kernel pool exploitation">
<meta property="og:url" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/index.html">
<meta property="og:site_name" content="皮三宝のBlog">
<meta property="og:description" content="读书笔记">
<meta property="og:locale">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424202332180.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424203009047.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424203517687.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424221352684.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425212050409.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425212500026.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425213253958.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425214825410.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425215405298.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220425220245300.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220426000620856.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424170843744.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424171234739.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424171727774.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424171816800.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424171829312.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424171852826.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424172010308.png">
<meta property="og:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424172026586.png">
<meta property="article:published_time" content="2022-04-16T18:06:40.000Z">
<meta property="article:modified_time" content="2024-07-22T01:48:18.180Z">
<meta property="article:author" content="皮三宝">
<meta property="article:tag" content="windows">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/image-20220424202332180.png">
  
  
  
  <title>windows10 kernel pool exploitation - 皮三宝のBlog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.psbazx.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>pisanbao</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="windows10 kernel pool exploitation"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-04-16 18:06" pubdate>
          April 16, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k wörter
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          109 minuten
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">windows10 kernel pool exploitation</h1>
            
            
              <div class="markdown-body">
                
                <p>读书笔记</p>
<a id="more"></a>

<p>参考链接</p>
<p><a target="_blank" rel="noopener" href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.synacktiv.com/sites/default/files/2021-10/2021_sthack_windows_lpe.pdf">https://www.synacktiv.com/sites/default/files/2021-10/2021_sthack_windows_lpe.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/synacktiv/Windows-kernel-SegmentHeap-Aligned-Chunk-Confusion">https://github.com/synacktiv/Windows-kernel-SegmentHeap-Aligned-Chunk-Confusion</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cbayet/Exploit-CVE-2017-6008/blob/master/Windows10PoolParty.pdf">https://github.com/cbayet/Exploit-CVE-2017-6008/blob/master/Windows10PoolParty.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals-wp.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals-wp.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Yason-Windows-10-Segment-Heap-Internals.pdf</a></p>
<p>学习顺序建议先把用户态的segment heap了解下再去看内核态相对容易些。</p>
<h1 id="Pool-internals"><a href="#Pool-internals" class="headerlink" title="Pool internals"></a>Pool internals</h1><p>先简单介绍下，segment heap之前只在用户态使用，且只针对部分系统特定进程，还有很多进程仍使用nt heap，19H1更新后segment heap被运用到了内核。</p>
<p>有关pool的一些结构体和基础知识这边不多提，可以看以前写过的博客。或者Tarjei Mandt的那篇<code>Kernel Pool Exploitation on Windows 7. Blackhat DC, 2011.</code></p>
<p>win8后推出了NonPagedPoolNx，其实和nonpagedpool没什么两样，除了代码不可执行。这用来防止在nonpagedpool中存放shellcode执行。nonpagedpool的分配现在会默认使用nonpagedpoolnx，nonpagedpool的type还存在主要是因为要适配一些老的第三方驱动。</p>
<p>内核态的Segment Heap和用户态的很像，目的是为了给不同大小的堆块提供不同的特征。主要有以下四种</p>
<p><code>— Low Fragmentation Heap (abbr LFH): RtlHpLfhContextAllocate </code></p>
<p><code>— Variable Size (abbr VS): RtlHpVsContextAllocateInternal </code></p>
<p><code>— Segment Alloc (abbr Seg): RtlHpSegAlloc </code></p>
<p><code>— Large Alloc: RtlHpLargeAlloc</code></p>
<p><img src="image-20220424202332180.png" srcset="/img/loading.gif" lazyload alt="image-20220424202332180"></p>
<p>前三种涉及到了几个结构体_HEAP_SEG_CONTEXT，_HEAP_VS_CONTEXT，_HEAP_LFH_CONTEXT。_SEGMENT_HEAP存放了这些结构体。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs llvm">kd &gt; dt nt! _SEGMENT_HEAP<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">000</span> EnvHandle : RTL_HP_ENV_HANDLE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">010</span> Signature : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">014</span> GlobalFlags : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">018</span> Interceptor : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span><span class="hljs-keyword">c</span> ProcessHeapListIndex : Uint<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span>e AllocatedFromMetadata : Pos <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span> Bit<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">020</span> CommitLimitData : _RTL_HEAP_MEMORY_LIMIT_DATA<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">020</span> ReservedMustBeZero<span class="hljs-number">1</span> : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">028</span> UserContext : Ptr<span class="hljs-number">64</span> Void<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">030</span> ReservedMustBeZero<span class="hljs-number">2</span> : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">038</span> Spare : Ptr<span class="hljs-number">64</span> Void<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">040</span> LargeMetadataLock : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">048</span> LargeAllocMetadata : _RTL_RB_TREE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">058</span> LargeReservedPages : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">060</span> LargeCommittedPages : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">068</span> StackTraceInitVar : _RTL_RUN_ONCE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">080</span> MemStats : _HEAP_RUNTIME_MEMORY_STATS<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0</span>d<span class="hljs-number">8</span> GlobalLockCount : Uint<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0</span>dc GlobalLockOwner : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0e0</span> ContextExtendLock : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0e8</span> AllocatedBase : Ptr<span class="hljs-number">64</span> UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0</span>f<span class="hljs-number">0</span> UncommittedBase : Ptr<span class="hljs-number">64</span> UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">0</span>f<span class="hljs-number">8</span> ReservedLimit : Ptr<span class="hljs-number">64</span> UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">100</span> SegContexts : [<span class="hljs-number">2</span>] _HEAP_SEG_CONTEXT<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">280</span> VsContext : _HEAP_VS_CONTEXT<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">340</span> LfhContext : _HEAP_LFH_CONTEXT<br></code></pre></td></tr></table></figure>
<p>这类结构体存在五个，分别对应不同种类的pool type</p>
<p><code>— NonPaged pools (bit 0 unset) </code></p>
<p><code>— NonPagedNx pool (bit 0 unset and bit 9 set) </code></p>
<p><code>— Paged pools (bit 0 set) </code></p>
<p><code>— PagedSession pool (bit 5 and 1 set)</code></p>
<p>前三个都被存放在HEAP_POOL_NODES中，sessionpool的存放在current thread中</p>
<p><img src="image-20220424203009047.png" srcset="/img/loading.gif" lazyload alt="image-20220424203009047"></p>
<p>用户态的segment heap只用了一个Segment Allocation对于大小在128 KiB 和508 KiB。内核使用了俩个，第二个是对于大小在508 KiB 和 7 GiB的分配准备</p>
<h2 id="Segment-Backend"><a href="#Segment-Backend" class="headerlink" title="Segment Backend"></a>Segment Backend</h2><p>针对大小128 KiB 到 7 GiB.也会用去分配vs和lfh的backends</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-number">1</span>: kd &gt; dt nt! _HEAP_SEG_CONTEXT<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">000</span> SegmentMask : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">008</span> UnitShift : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">009</span> PagesPerUnitShift : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">00</span>a FirstDescriptorIndex : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">00</span>b CachedCommitSoftShift : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">00</span><span class="hljs-keyword">c</span> CachedCommitHighShift : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">00</span>d Flags : &lt;anonymous -tag &gt;<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">010</span> MaxAllocationSize : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">014</span> OlpStatsOffset : Int<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">016</span> MemStatsOffset : Int<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">018</span> LfhContext : Ptr<span class="hljs-number">64</span> Void<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">020</span> VsContext : Ptr<span class="hljs-number">64</span> Void<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">028</span> EnvHandle : RTL_HP_ENV_HANDLE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">038</span> Heap : Ptr<span class="hljs-number">64</span> Void<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">040</span> SegmentLock : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">048</span> SegmentListHead : _LIST_ENTRY<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">058</span> SegmentCount : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">060</span> FreePageRanges : _RTL_RB_TREE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">070</span> FreeSegmentListLock : Uint<span class="hljs-number">8</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">078</span> FreeSegmentList : [<span class="hljs-number">2</span>] _SINGLE_LIST_ENTRY<br></code></pre></td></tr></table></figure>
<p><img src="image-20220424203517687.png" srcset="/img/loading.gif" lazyload alt="image-20220424203517687"></p>
<p>每个segment backend分配的内存都有可变大小的段，每个段都有很多可分配的页。如上图所示，每个段都会被单向链表链接即SegmentListHead，下面紧跟着256个_HEAP_PAGE_RANGE_DESCRIPTOR结构体</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">1</span>: kd &gt; dt nt! _HEAP_PAGE_SEGMENT<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">ListEntry </span>: _LIST_ENTRY<br>+<span class="hljs-number">0</span> x010 <span class="hljs-attribute">Signature </span>: Uint8B<br>+<span class="hljs-number">0</span> x018 <span class="hljs-attribute">SegmentCommitState </span>: Ptr64 _HEAP_SEGMENT_MGR_COMMIT_STATE<br>+<span class="hljs-number">0</span> x020 <span class="hljs-attribute">UnusedWatermark </span>: UChar<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">DescArray </span>: [<span class="hljs-number">256</span>] _HEAP_PAGE_RANGE_DESCRIPTOR<br></code></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-number">1</span>: kd &gt; dt nt! _HEAP_PAGE_RANGE_DESCRIPTOR<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">000</span> TreeNode : _RTL_BALANCED_NODE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">000</span> TreeSignature : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">004</span> UnusedBytes : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">008</span> ExtraPresent : Pos <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span> Bit<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">008</span> Spare<span class="hljs-number">0</span> : Pos <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">15</span> Bits<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">018</span> RangeFlags : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">019</span> CommittedPageCount : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span>a Spare : Uint<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span><span class="hljs-keyword">c</span> Key : _HEAP_DESCRIPTOR_KEY<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span><span class="hljs-keyword">c</span> Align : [<span class="hljs-number">3</span>] UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span>f UnitOffset : UChar<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span>f UnitSize : UChar<br></code></pre></td></tr></table></figure>
<p>为了快速的寻找被释放的页范围。_HEAP_SEG_CONTEXT还维护了一个RB tree，每个都有一个signature成员，计算公式如下</p>
<p><code>Signature = Segment ^ SegContext ^ RtlpHpHeapGlobals ^ 0 xA2E64EADA2E64EAD ;</code></p>
<p>signature用于check他隶属于的_HEAP_SEG_CONTEXT结构体和对应的_SEGMENT_HEAP。</p>
<p>_HEAP_SEG_CONTEXT里的SegmentMask是用来帮助计算隶属于的段SegmentMask值为0xfffffffffff00000</p>
<p><code>Segment = Addr &amp; SegContext -&gt; SegmentMask ;</code></p>
<p>对应的PageRange也可以通过 _HEAP_SEG_CONTEXT里的UnitShift来计算，UnitShift值为12</p>
<p><code>PageRange = Segment + sizeof ( _HEAP_PAGE_RANGE_DESCRIPTOR ) * ( Addr - Segment ) &gt;&gt; SegContext -&gt; UnitShift ;</code></p>
<p>当Segment Backend被其他的backend使用时_HEAP_PAGE_RANGE_DESCRIPTOR中的RangeFlags会设置对应的位数来表明是哪个backend请求的。</p>
<h2 id="Variable-Size-Backend"><a href="#Variable-Size-Backend" class="headerlink" title="Variable Size Backend"></a>Variable Size Backend</h2><p>可变大小堆针对大小在512 B 和 128 KiB之间。目的是为了提供针对释放对快的便捷再利用。</p>
<p>Variable Size Backend context存储在_HEAP_VS_CONTEXT结构体中</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">0</span>: kd &gt; dt nt! _HEAP_VS_CONTEXT<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">Lock </span>: Uint8B<br>+<span class="hljs-number">0</span> x008 <span class="hljs-attribute">LockType </span>: _RTLP_HP_LOCK_TYPE<br>+<span class="hljs-number">0</span> x010 <span class="hljs-attribute">FreeChunkTree </span>: _RTL_RB_TREE<br>+<span class="hljs-number">0</span> x020 <span class="hljs-attribute">SubsegmentList </span>: _LIST_ENTRY<br>+<span class="hljs-number">0</span> x030 <span class="hljs-attribute">TotalCommittedUnits </span>: Uint8B<br>+<span class="hljs-number">0</span> x038 <span class="hljs-attribute">FreeCommittedUnits </span>: Uint8B<br>+<span class="hljs-number">0</span> x040 <span class="hljs-attribute">DelayFreeContext </span>: _HEAP_VS_DELAY_FREE_CONTEXT<br>+<span class="hljs-number">0</span> x080 <span class="hljs-attribute">BackendCtx </span>: Ptr64 Void<br>+<span class="hljs-number">0</span> x088 <span class="hljs-attribute">Callbacks </span>: _HEAP_SUBALLOCATOR_CALLBACKS<br>+<span class="hljs-number">0</span> x0b0 <span class="hljs-attribute">Config </span>: _RTL_HP_VS_CONFIG<br>+<span class="hljs-number">0</span> x0b4 <span class="hljs-attribute">Flags </span>: Uint4B<br></code></pre></td></tr></table></figure>
<p>被释放的堆块会被存放在FreeChunkTree中，这是个rb tree。当请求分配空间时，红黑树会返回他遍历到的与请求大小相等的的chunk或者是第一个比请求大小size大的chunk。</p>
<p>free chunk的头部是一个_HEAP_VS_CHUNK_FREE_HEADER结构体</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_FREE_HEADER<br>+<span class="hljs-number">0</span> x000 Header : _HEAP_VS_CHUNK_HEADER<br>+<span class="hljs-number">0</span> x000 OverlapsHeader : Uint8B<br>+<span class="hljs-number">0</span> x008 <span class="hljs-keyword">Node</span> <span class="hljs-title">: _RTL_BALANCED_NODE</span><br></code></pre></td></tr></table></figure>
<p>一旦chunk被找到，他会被分割成合适的大小，通过调用RtlpHpVsChunkSplit</p>
<p>所有被分配的chunk都会有个新头部_HEAP_VS_CHUNK_HEADER，如下所示</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">0:</span> <span class="hljs-string">kd</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">dt</span> <span class="hljs-string">nt!</span> <span class="hljs-string">_HEAP_VS_CHUNK_HEADER</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 Sizes :</span> <span class="hljs-string">_HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x008 EncodedSegmentPageOffset :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-number">8</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x008 UnusedBytes :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">8</span><span class="hljs-string">,</span> <span class="hljs-number">1</span> <span class="hljs-string">Bit</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x008 SkipDuringWalk :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">9</span><span class="hljs-string">,</span> <span class="hljs-number">1</span> <span class="hljs-string">Bit</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x008 Spare :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">10</span><span class="hljs-string">,</span> <span class="hljs-number">22</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x008 AllocatedChunkBits :</span> <span class="hljs-string">Uint4B</span><br><span class="hljs-attr">0:</span> <span class="hljs-string">kd</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">dt</span> <span class="hljs-string">nt!</span> <span class="hljs-string">_HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 MemoryCost :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-number">16</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 UnsafeSize :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">16</span><span class="hljs-string">,</span> <span class="hljs-number">16</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x004 UnsafePrevSize :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-number">16</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x004 Allocated :</span> <span class="hljs-string">Pos</span> <span class="hljs-number">16</span><span class="hljs-string">,</span> <span class="hljs-number">8</span> <span class="hljs-string">Bits</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 KeyUShort :</span> <span class="hljs-string">Uint2B</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 KeyULong :</span> <span class="hljs-string">Uint4B</span><br><span class="hljs-string">+0</span> <span class="hljs-attr">x000 HeaderBits :</span> <span class="hljs-string">Uint8B</span><br></code></pre></td></tr></table></figure>
<p>头部的所有成员都会与RtlpHpHeapGlobals还有chunk地址进行xor</p>
<p><code>Chunk -&gt; Sizes = Chunk -&gt; Sizes ^ Chunk ^ RtlpHpHeapGlobals ;</code></p>
<p><img src="image-20220424221352684.png" srcset="/img/loading.gif" lazyload alt="image-20220424221352684"></p>
<h2 id="Low-Fragmentation-Heap-Backend"><a href="#Low-Fragmentation-Heap-Backend" class="headerlink" title="Low Fragmentation Heap Backend"></a>Low Fragmentation Heap Backend</h2><p>LFH为一些较小的分配准备。大小在1 B 到 512 B之间。</p>
<p>LFH Backend context存储在_HEAP_LFH_CONTEXT结构体中如下所示</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">0</span>: kd &gt; dt nt! _HEAP_LFH_CONTEXT<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">BackendCtx </span>: Ptr64 Void<br>+<span class="hljs-number">0</span> x008 <span class="hljs-attribute">Callbacks </span>: _HEAP_SUBALLOCATOR_CALLBACKS<br>+<span class="hljs-number">0</span> x030 <span class="hljs-attribute">AffinityModArray </span>: Ptr64 UChar<br>+<span class="hljs-number">0</span> x038 <span class="hljs-attribute">MaxAffinity </span>: UChar<br>+<span class="hljs-number">0</span> x039 <span class="hljs-attribute">LockType </span>: UChar<br>+<span class="hljs-number">0</span> x03a <span class="hljs-attribute">MemStatsOffset </span>: Int2B<br>+<span class="hljs-number">0</span> x03c <span class="hljs-attribute">Config </span>: _RTL_HP_LFH_CONFIG<br>+<span class="hljs-number">0</span> x040 <span class="hljs-attribute">BucketStats </span>: _HEAP_LFH_SUBSEGMENT_STATS<br>+<span class="hljs-number">0</span> x048 <span class="hljs-attribute">SubsegmentCreationLock </span>: Uint8B<br>+<span class="hljs-number">0</span> x080 <span class="hljs-attribute">Buckets </span>: [<span class="hljs-number">129</span>] Ptr64 _HEAP_LFH_BUCKET<br></code></pre></td></tr></table></figure>
<p>LFH最主要的特征使用了不同大小的bucket来防止内存碎片</p>
<p><img src="image-20220425212050409.png" srcset="/img/loading.gif" lazyload alt="image-20220425212050409"></p>
<p>每个buckets都由段分配器来分配，位于_HEAP_LFH_CONTEXT的_HEAP_SUBALLOCATOR_CALLBACKS处</p>
<p>_HEAP_SUBALLOCATOR_CALLBACKS的一下成员会与LFH context地址还有RtlpHpHeapGlobals XOR</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">callbacks . Allocate = RtlpHpSegLfhAllocate ;<br>callbacks . Free = RtlpHpSegLfhVsFree ;<br>callbacks . Commit = RtlpHpSegLfhVsCommit ;<br>callbacks . Decommit = RtlpHpSegLfhVsDecommit ;<br>callbacks . ExtendContext = RtlpHpSegLfhExtendContext ;<br></code></pre></td></tr></table></figure>
<p>每个subsegment都有一个_HEAP_LFH_SUBSEGMENT头</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">0</span>: kd &gt; dt nt! _HEAP_LFH_SUBSEGMENT<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">ListEntry </span>: _LIST_ENTRY<br>+<span class="hljs-number">0</span> x010 <span class="hljs-attribute">Owner </span>: Ptr64 _HEAP_LFH_SUBSEGMENT_OWNER<br>+<span class="hljs-number">0</span> x010 <span class="hljs-attribute">DelayFree </span>: _HEAP_LFH_SUBSEGMENT_DELAY_FREE<br>+<span class="hljs-number">0</span> x018 <span class="hljs-attribute">CommitLock </span>: Uint8B<br>+<span class="hljs-number">0</span> x020 <span class="hljs-attribute">FreeCount </span>: Uint2B<br>+<span class="hljs-number">0</span> x022 <span class="hljs-attribute">BlockCount </span>: Uint2B<br>+<span class="hljs-number">0</span> x020 <span class="hljs-attribute">InterlockedShort </span>: Int2B<br>+<span class="hljs-number">0</span> x020 <span class="hljs-attribute">InterlockedLong </span>: Int4B<br>+<span class="hljs-number">0</span> x024 <span class="hljs-attribute">FreeHint </span>: Uint2B<br>+<span class="hljs-number">0</span> x026 <span class="hljs-attribute">Location </span>: UChar<br>+<span class="hljs-number">0</span> x027 <span class="hljs-attribute">WitheldBlockCount </span>: UChar<br>+<span class="hljs-number">0</span> x028 <span class="hljs-attribute">BlockOffsets </span>: _HEAP_LFH_SUBSEGMENT_ENCODED_OFFSETS<br>+<span class="hljs-number">0</span> x02c <span class="hljs-attribute">CommitUnitShift </span>: UChar<br>+<span class="hljs-number">0</span> x02d <span class="hljs-attribute">CommitUnitCount </span>: UChar<br>+<span class="hljs-number">0</span> x02e <span class="hljs-attribute">CommitStateOffset </span>: Uint2B<br>+<span class="hljs-number">0</span> x030 <span class="hljs-attribute">BlockBitmap </span>: [<span class="hljs-number">1</span>] Uint8B<br></code></pre></td></tr></table></figure>
<p>每个subsegment都会被分割成对应不同buckets大小的LFH块，为了知道哪个bucket正被使用，_HEAP_LFH_SUBSEGMENT里维护了一个bitmap</p>
<p><img src="image-20220425212500026.png" srcset="/img/loading.gif" lazyload alt="image-20220425212500026"></p>
<p>当有分配请求时，LFH分配器会先寻找_HEAP_LFH_SUBSEGMENT中的FreeHint来找到最近被释放的block，然后回遍历BlockBitmap，每次32 blocks来寻找free的block。因为RtlpLowFragHeapRandomData表，这个遍历会很随机。也就是这个导致了first fit不再适用。</p>
<p>根据每个bucket的征用情况，可能会启用一个Affinity Slot机制，通过把每个子段专用于每个cpu来简化分配。</p>
<h2 id="Dynamic-Lookaside"><a href="#Dynamic-Lookaside" class="headerlink" title="Dynamic Lookaside"></a>Dynamic Lookaside</h2><p>0x200到0xF80大小之间的free chunk会被暂时的存放到lookaside list中，这个和win7的很像。当chunk存放到list里后，不会调用对应chunk的free处理函数。</p>
<p>lookaside list是个_RTL_DYNAMIC_LOOKASIDE结构体，位于 _SEGMENT_HEAP 的UserContext处。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">0</span>: kd &gt; dt nt! _RTL_DYNAMIC_LOOKASIDE<br>+<span class="hljs-number">0</span> x000 <span class="hljs-attribute">EnabledBucketBitmap </span>: Uint8B<br>+<span class="hljs-number">0</span> x008 <span class="hljs-attribute">BucketCount </span>: Uint4B<br>+<span class="hljs-number">0</span> x00c <span class="hljs-attribute">ActiveBucketCount </span>: Uint4B<br>+<span class="hljs-number">0</span> x040 <span class="hljs-attribute">Buckets </span>: [<span class="hljs-number">64</span>] _RTL_LOOKASIDE<br></code></pre></td></tr></table></figure>
<p>每个free chunk会根据大小存放于_RTL_LOOKASIDE中</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-number">0</span>: kd &gt; dt nt! _RTL_LOOKASIDE<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">000</span> ListHead : _SLIST_HEADER<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">010</span> Depth : Uint<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">012</span> MaximumDepth : Uint<span class="hljs-number">2</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">014</span> TotalAllocates : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">018</span> AllocateMisses : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">01</span><span class="hljs-keyword">c</span> TotalFrees : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">020</span> FreeMisses : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">024</span> LastTotalAllocates : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">028</span> LastAllocateMisses : Uint<span class="hljs-number">4</span>B<br>+<span class="hljs-number">0</span> <span class="hljs-keyword">x</span><span class="hljs-number">02</span><span class="hljs-keyword">c</span> LastTotalFrees : Uint<span class="hljs-number">4</span>B<br></code></pre></td></tr></table></figure>
<p><img src="image-20220425213253958.png" srcset="/img/loading.gif" lazyload alt="image-20220425213253958"></p>
<p>每次只会启用一个buckets。当一次分配请求完成时，lookaside对应的引用计数会更新。</p>
<h2 id="POOL-HEADER"><a href="#POOL-HEADER" class="headerlink" title="POOL_HEADER"></a>POOL_HEADER</h2><p>这个不多介绍了,主要提一下CacheAligned位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">POOL_HEADER</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-keyword">char</span> PreviousSize ;<br><span class="hljs-keyword">char</span> PoolIndex ;<br><span class="hljs-keyword">char</span> BlockSize ;<br><span class="hljs-keyword">char</span> PoolType ;<br><span class="hljs-keyword">int</span> PoolTag ;<br>Ptr64 ProcessBilled ;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>随着内核池分配器的更新很多结构都没啥用了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">PoolHeader -&gt; PoolTag = PoolTag ;<br>PoolHeader -&gt; BlockSize = BucketBlockSize &gt;&gt; <span class="hljs-number">4</span>;<br>PoolHeader -&gt; PreviousSize = <span class="hljs-number">0</span>;<br>PoolHeader -&gt; PoolType = changedPoolType &amp; <span class="hljs-number">0</span> x6D | <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>
<p><code>PreviousSize</code> Unused and kept to 0.</p>
<p><code>PoolIndex</code> Unused.</p>
<p><code>BlockSize</code> Size of the chunk. Only used to eventually store the chunk in the Dynamic Lookaside list </p>
<p><code>PoolType</code> Usage did not change; used to keep the requested POOL_TYPE.</p>
<p><code>PoolTag</code> Usage did not change; used to keep the PoolTag.</p>
<p><code>ProcessBilled</code> Usage did not change; used to keep track of which process required the allocation, if the PoolType is PoolQuota (bit 3). The value is computed as follow:</p>
<p><code>ProcessBilled = chunk_addr ^ ExpPoolQuotaCookie ^ KPROCESS ;</code></p>
<p>可以发现和Quota Process Pointer Overwrite这个打法相关的结构体都没怎么变，除了ProcessBilled进行了xor。</p>
<p>下面讲讲CacheAligned，当PoolType中这个位被设置时，返回的内存会和cache line对齐，这个cache line大小取决于cpu一般都是0x40.</p>
<p>首先分配器会把请求大小加上ExpCacheLineSize</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( PoolType &amp; <span class="hljs-number">4</span> )<br>&#123;<br>	request_alloc_size += ExpCacheLineSize ;<br>	<span class="hljs-keyword">if</span> ( request_alloc_size &gt; <span class="hljs-number">0</span> xFE0 )<br>        &#123;<br>        request_alloc_size -= ExpCacheLineSize ;<br>        PoolType = PoolType &amp; <span class="hljs-number">0</span> xFB ;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果新的大小不能放在一整个页，那CacheAligned位会被忽视，然后被分配的chunk必须遵循三个条件</p>
<p><code>— the final allocation address must be aligned on ExpCacheLineSize; </code></p>
<p><code>— the chunk must have a POOL_HEADER at the very beginning of the chunk; </code></p>
<p><code>— the chunk must have a POOL_HEADER at the address of allocation minus sizeof(POOL_HEADER)</code></p>
<p>所以这可能会导致有俩个pool header</p>
<p><img src="image-20220425214825410.png" srcset="/img/loading.gif" lazyload alt="image-20220425214825410"></p>
<p>第一个header会在chunk开头，第二个会对齐。然后CacheAligned位会从第一个header移除，第二个header会有以下值</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">PreviousSize Used <span class="hljs-built_in">to</span> store <span class="hljs-keyword">the</span> <span class="hljs-built_in">offset</span> between <span class="hljs-keyword">the</span> <span class="hljs-literal">two</span> headers.<br>PoolIndex Unused.<br>BlockSize Size <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> allocated bucket <span class="hljs-keyword">in</span> <span class="hljs-keyword">first</span> POOL_HEADER, reduced<br>size <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">second</span> <span class="hljs-literal">one</span>.<br>PoolType As usual, but <span class="hljs-keyword">the</span> CacheAligned bit is <span class="hljs-built_in">set</span>.<br>PoolTag As usual, same <span class="hljs-keyword">on</span> <span class="hljs-title">both</span> <span class="hljs-title">POOL_HEADER</span>.<br>ProcessBilled Unused.<br></code></pre></td></tr></table></figure>
<p>主要看prevsize，会被用于定位第一个header，这就是我们可以利用的点。</p>
<p>值得一提的是，假如有足够的空间，第一个header后可能会紧跟着一个AlignedPoolHeader指针用于指向下一个header，这个指针会和ExpPoolQuotaCookie xor。</p>
<p><img src="image-20220425215405298.png" srcset="/img/loading.gif" lazyload alt="image-20220425215405298"></p>
<p>可以看到随着poolheader在win10中的“削弱”，从攻击的角度去讲其实少了许多办法，像ProcessBilled这种指针都会进行加密，如果没有leak其实利用起来难度很大。</p>
<p>假如数据可控，最好的办法还是直接覆写poolheader然后溢出到下一个chunk结构体，这只需要找到一个带有指针且用户态提供读写api的结构体即可。就像31956里面用到的wnf结构体。</p>
<p>还有俩种攻击poolheader的办法一个是修改blocksize</p>
<p><img src="image-20220425220245300.png" srcset="/img/loading.gif" lazyload alt="image-20220425220245300"></p>
<p>用于分配一个更大的堆块。</p>
<p>还有一个就是攻击PoolType也就是Aligned Chunk Confusion打法</p>
<p>free的chunk CacheAligned位被设置分配器会去根据prevsize找到first header</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( AlignedHeader -&gt; PoolType &amp; <span class="hljs-number">4</span> )<br>&#123;<br>OriginalHeader = ( QWORD ) AlignedHeader - AlignedHeader -&gt;<br>PreviousSize * <span class="hljs-number">0</span> x10 ;<br>OriginalHeader -&gt; PoolType |= <span class="hljs-number">4</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Segment Heap推出后一些check被消除了，可能后续会被重新启用，因为之前提过first header后可能会紧跟这一个指针。这个指针没有在free的时候被check。</p>
<p><img src="image-20220426000620856.png" srcset="/img/loading.gif" lazyload alt="image-20220426000620856"></p>
<h1 id="Aligned-Chunk-Confusion"><a href="#Aligned-Chunk-Confusion" class="headerlink" title="Aligned Chunk Confusion"></a>Aligned Chunk Confusion</h1><p>SSTIC2020那篇slides提到了这个打法，适用于paged or nonpaged pool</p>
<p>利用条件是溢出四个字节，且previoussize和pooltype这俩处可控。</p>
<p>简单介绍下这个打法。</p>
<p>最终利用的打法还是Quota Process Pointer Overwrite来达成任意地址减一（不了解的可以看我之前写的win7 kernel pool的博客），因为win8后多了mitigation。</p>
<p><code>ProcessBilled = addrof(EPROCESS) ⊕ addrof(Chunk) ⊕ ExpPoolQuotaCookie</code></p>
<p>所以在伪造eprocess前需要先有个任意读来leak。</p>
<p>slides里面以pagedpool为例用的结构体是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PipeAttribute</span> &#123;</span><br>LIST_ENTRY attribute_list ;<br><span class="hljs-keyword">char</span> * AttributeName ;<br><span class="hljs-keyword">uint64_t</span> AttributeValueSize ;<br><span class="hljs-keyword">char</span> * AttributeValue ;<br><span class="hljs-keyword">char</span> data [<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>和file ea差不多name用来查找，value用来存放。只要能修改value的指针就能达成任意地址读取，因为三环没有提供修改value的api所以任意地址写目前还不能。</p>
<p>下面介绍下Aligned Chunk</p>
<p><img src="image-20220424170843744.png" srcset="/img/loading.gif" lazyload alt="image-20220424170843744"></p>
<p>当free时会根据prevsize去找到真正的pool header，在segment heap提出前会有很多check，现在都没了，详细可以看slides这边不多赘述。</p>
<p>所以要想利用现实设置好溢出堆块的pooltype为Aligned Chunk然后是prevsize，根据prevsize可以定位到我们伪造的fake header处</p>
<p><img src="image-20220424171234739.png" srcset="/img/loading.gif" lazyload alt="image-20220424171234739"></p>
<p>下面调用NtfsControlFile来往fakechunk处分配一个pipeattribute结构体。接着利用再次调用NtfsControlFile来leak。</p>
<p><img src="image-20220424171727774.png" srcset="/img/loading.gif" lazyload alt="image-20220424171727774"></p>
<p>然后把前面的pipeattr free后再分配一个并伪造listentry，伪造一个pipe再用户态地址</p>
<p><img src="image-20220424171816800.png" srcset="/img/loading.gif" lazyload alt="image-20220424171816800"></p>
<p><img src="image-20220424171829312.png" srcset="/img/loading.gif" lazyload alt="image-20220424171829312"></p>
<p>设置指针为之前leak的值即可。</p>
<p><img src="image-20220424171852826.png" srcset="/img/loading.gif" lazyload alt="image-20220424171852826"></p>
<p>利用任意地址读可以leak出ExpPoolQuotaCookie，EPROCESS和token地址。</p>
<p><img src="image-20220424172010308.png" srcset="/img/loading.gif" lazyload alt="image-20220424172010308"></p>
<p><img src="image-20220424172026586.png" srcset="/img/loading.gif" lazyload alt="image-20220424172026586"></p>
<p>接着配合任意地址减一，注入代码到winlogon即可达成提权。</p>
<p>有几个注意点</p>
<p>构造的fake header的blocksize至少是0x21</p>
<p>因为0x200以下都会使用LFH，我们必须用vs分配器才能利用dynamic lookaside list所以至少0x200，对应的chunk大小是0x210.</p>
<p>另外，win7里面这个打法只需要减一次Privileges.Enabled在低权限一般都为0x0000000000800000，减一后是0x000000000007ffff有了SeDebugPrivilege。</p>
<p>但是在win10，内核会利用AdjustTokenPrivileges来check，Privileges.Present &amp; Privileges.Enabled</p>
<p>Privileges.Present在低权限下一般都是0x602880000然而</p>
<p><code>0x602880000 &amp; (1«20) == 0</code></p>
<p>所以如果在低权限下还需要再次利用一波，需要再次对Privileges.Present进行减一操作。</p>
<p>其次</p>
<p>漏洞块大小至少0x130，否则ghost会覆写漏洞快，会被分配到漏洞快之前。vs chunk和lfh chunk有一些区别，大部分vs chunk都会多一个vs header，这意味着需要溢出至少0x14字节而且需要修复vs header。并且要注意free的时候得保证不会触发merge操作。</p>
<h1 id="Non-Paged-POOL"><a href="#Non-Paged-POOL" class="headerlink" title="Non-Paged POOL"></a>Non-Paged POOL</h1><p><a target="_blank" rel="noopener" href="https://github.com/vp777/Windows-Non-Paged-Pool-Overflow-Exploitation">https://github.com/vp777/Windows-Non-Paged-Pool-Overflow-Exploitation</a></p>
<p>这个打法就复杂很多了，针对的是nonpaged pool，这个洞之前我也看过，品相并不是很好。这个作者提出的打法适用于很多种情况可以达到任意读写。后续单独开篇文章写下。</p>
<p>SSTIC2020文章里也给出了一个结构体用于利用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PipeQueueEntry</span></span><br><span class="hljs-class">&#123;</span><br>LIST_ENTRY <span class="hljs-built_in">list</span> ;<br>IRP * linkedIRP ;<br>__int64 SecurityClientContext ;<br><span class="hljs-keyword">int</span> isDataInKernel ;<br><span class="hljs-keyword">int</span> remaining_bytes__ ;<br><span class="hljs-keyword">int</span> DataSize ;<br><span class="hljs-keyword">int</span> field_2C ;<br><span class="hljs-keyword">char</span> data [<span class="hljs-number">1</span>];<br>&#125;;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( PipeQueueEntry -&gt; isDataAllocated == <span class="hljs-number">1</span> )<br>data_ptr = ( PipeQueueEntry -&gt; linkedIRP -&gt; SystemBuffer );<br><span class="hljs-keyword">else</span><br>data_ptr = PipeQueueEntry -&gt; data ;<br>[...]<br>memmove (( <span class="hljs-keyword">void</span> *)( dst_buf + dst_len - cur_read_offset ), &amp; data_ptr [<br>PipeQueueEntry -&gt; DataSize - cur_entry_offset ], copy_size );<br></code></pre></td></tr></table></figure>
<p>当isDataInKernel被设置成1后，data不会直接存放在结构体后。会放在linkedIRP中，我们可以通过修改linkedIRP指针到用户态并设置好对应的SystemBuffer，就可以达到任意地址读。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/windows/">#windows</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>windows10 kernel pool exploitation</div>
      <div>http://www.psbazx.com/2022/04/17/windows10-kernel-pool-exploitation/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Beitragsautor</div>
          <div>皮三宝</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Veröffentlicht am</div>
          <div>April 16, 2022</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Urheberrechtshinweis</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/09/%E6%AF%8F%E5%91%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02022-8%E6%9C%88/" title="每周学习笔记2022-8月">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">每周学习笔记2022-8月</span>
                        <span class="visible-mobile">Vorheriger</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/04/06/%E5%85%B3%E4%BA%8E32%E4%BD%8D%E4%B8%8E64%E4%BD%8D%E7%A8%8B%E5%BA%8F%E5%88%87%E6%8D%A2/" title="关于32位与64位程序切换">
                        <span class="hidden-mobile">关于32位与64位程序切换</span>
                        <span class="visible-mobile">Nächster</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Inhaltsverzeichnis</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Suchen</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Stichwort</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog funktioniert am besten mit aktiviertem JavaScript</div>
  </noscript>
</body>
</html>
