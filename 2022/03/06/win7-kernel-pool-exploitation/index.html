

<!DOCTYPE html>
<html lang="zh-Hans" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/pisanbao.jpg">
  <link rel="icon" href="/img/pisanbao.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="皮三宝">
  <meta name="keywords" content="">
  
    <meta name="description" content="读书笔记 具体看Tarjei Mandt的slides">
<meta property="og:type" content="article">
<meta property="og:title" content="win7 kernel pool exploitation">
<meta property="og:url" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/index.html">
<meta property="og:site_name" content="皮三宝のBlog">
<meta property="og:description" content="读书笔记 具体看Tarjei Mandt的slides">
<meta property="og:locale">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312005121553.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312005145088.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312131859710.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312134131427.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312140627548.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312151217350.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312153130972.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312153451750.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312153500233.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312172719376.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312172901824.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312172910202.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312173044434.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312214235884.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313161741951.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313162938437.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313163045816.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313164923505.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313165752682.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313182326244.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313182554224.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313184205978.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313184352212.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313185239225.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312230728966.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312230738585.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312231425488.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312233606903.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313192704619.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313193149716.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313194116696.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313194940466.png">
<meta property="og:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220313195113201.png">
<meta property="article:published_time" content="2022-03-06T00:48:06.000Z">
<meta property="article:modified_time" content="2024-07-22T01:48:18.153Z">
<meta property="article:author" content="皮三宝">
<meta property="article:tag" content="windows">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/image-20220312005121553.png">
  
  
  
  <title>win7 kernel pool exploitation - 皮三宝のBlog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.psbazx.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>pisanbao</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="win7 kernel pool exploitation"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-03-06 00:48" pubdate>
          March 6, 2022 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          16k wörter
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          135 minuten
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">win7 kernel pool exploitation</h1>
            
            
              <div class="markdown-body">
                
                <p>读书笔记</p>
<p>具体看Tarjei Mandt的slides</p>
<a id="more"></a>

<p>因为工作需要，对win7的内核漏洞利用需要了解下。</p>
<h1 id="Kernel-Pool-Internals"><a href="#Kernel-Pool-Internals" class="headerlink" title="Kernel Pool Internals"></a>Kernel Pool Internals</h1><p>池描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">POOL_DESCRIPTOR</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x000*/</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> _<span class="hljs-title">POOL_TYPE</span> <span class="hljs-title">PoolType</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/*0x004*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KGUARDED_MUTEX</span> <span class="hljs-title">PagedLock</span>;</span><br><span class="hljs-comment">/*0x004*/</span> ULONG32 NonPagedLock;<br>&#125;;<br><span class="hljs-comment">/*0x040*/</span> LONG32 RunningAllocs;<br><span class="hljs-comment">/*0x044*/</span> LONG32 RunningDeAllocs;<br><span class="hljs-comment">/*0x048*/</span> LONG32 TotalBigPages;<br><span class="hljs-comment">/*0x04C*/</span> LONG32 ThreadsProcessingDeferrals;<br><span class="hljs-comment">/*0x050*/</span> ULONG32 TotalBytes;<br><span class="hljs-comment">/*0x054*/</span> UINT8 _PADDING0_[<span class="hljs-number">0x2C</span>];<br><span class="hljs-comment">/*0x080*/</span> ULONG32 PoolIndex;<br><span class="hljs-comment">/*0x084*/</span> UINT8 _PADDING1_[<span class="hljs-number">0x3C</span>];<br><span class="hljs-comment">/*0x0C0*/</span> LONG32 TotalPages;<br><span class="hljs-comment">/*0x0C4*/</span> UINT8 _PADDING2_[<span class="hljs-number">0x3C</span>];<br><span class="hljs-comment">/*0x100*/</span> VOID** PendingFrees;<br><span class="hljs-comment">/*0x104*/</span> LONG32 PendingFreeDepth;<br><span class="hljs-comment">/*0x108*/</span> UINT8 _PADDING3_[<span class="hljs-number">0x38</span>];<br><span class="hljs-comment">/*0x140*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">LIST_ENTRY</span> <span class="hljs-title">ListHeads</span>[512];</span><br>&#125; POOL_DESCRIPTOR, *PPOOL_DESCRIPTOR;<br></code></pre></td></tr></table></figure>
<p>用于管理内核堆块，负责记录在使用中的堆块数目等其他与堆块相关的信息。</p>
<p>PendingFrees指向延迟释放列表，是一个单项链表存放等待呗释放的堆块。</p>
<p>ListHeads是一个双向链表，链接相同大小的被释放块。每个单位占8字节。被free的chunk进入listheads时会根据block size来计算下标，计算方式就是乘8除8然后四舍五入，BlockSize = (NumberOfBytes+0xF) &gt;&gt; 3。进行这些操作是为了给pool header预留空间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">POOL_HEADER</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/*0x000*/</span> UINT16 PreviousSize : <span class="hljs-number">9</span>;<br><span class="hljs-comment">/*0x000*/</span> UINT16 PoolIndex : <span class="hljs-number">7</span>;<br><span class="hljs-comment">/*0x002*/</span> UINT16 BlockSize : <span class="hljs-number">9</span>;<br><span class="hljs-comment">/*0x002*/</span> UINT16 PoolType : <span class="hljs-number">7</span>;<br>&#125;;<br><span class="hljs-comment">/*0x000*/</span> ULONG32 Ulong1;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/*0x004*/</span> ULONG32 PoolTag;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/*0x004*/</span> UINT16 AllocatorBackTraceIndex;<br><span class="hljs-comment">/*0x006*/</span> UINT16 PoolTagHash;<br>&#125;;<br>&#125;;<br>&#125; POOL_HEADER, *PPOOL_HEADER;<br></code></pre></td></tr></table></figure>
<p>pool header存放了用于内存释放和分配算法必要的信息，比如PreviousSize表示前一个堆块的大小，可以用于定位前一个堆块，在合并堆块的时候。如果该堆块位于页的开头，这个可以为0.</p>
<p>poolindex表示下标，用来确保被释放到正确的index处。</p>
<p>pooltype表示堆块类型（paged nopaged等）同时也表明是否free，free的chunk会置0，否则置为POOL_TYPE or pool-in-use</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> _<span class="hljs-title">POOL_TYPE</span></span><br><span class="hljs-class">&#123;</span><br>NonPagedPool = <span class="hljs-number">0</span> <span class="hljs-comment">/*0x0*/</span>,<br>PagedPool = <span class="hljs-number">1</span> <span class="hljs-comment">/*0x1*/</span>,<br>NonPagedPoolMustSucceed = <span class="hljs-number">2</span> <span class="hljs-comment">/*0x2*/</span>,<br>DontUseThisType = <span class="hljs-number">3</span> <span class="hljs-comment">/*0x3*/</span>,<br>NonPagedPoolCacheAligned = <span class="hljs-number">4</span> <span class="hljs-comment">/*0x4*/</span>,<br>PagedPoolCacheAligned = <span class="hljs-number">5</span> <span class="hljs-comment">/*0x5*/</span>,<br>NonPagedPoolCacheAlignedMustS = <span class="hljs-number">6</span> <span class="hljs-comment">/*0x6*/</span>,<br>MaxPoolType = <span class="hljs-number">7</span> <span class="hljs-comment">/*0x7*/</span>,<br>NonPagedPoolSession = <span class="hljs-number">32</span> <span class="hljs-comment">/*0x20*/</span>,<br>PagedPoolSession = <span class="hljs-number">33</span> <span class="hljs-comment">/*0x21*/</span>,<br>NonPagedPoolMustSucceedSession = <span class="hljs-number">34</span> <span class="hljs-comment">/*0x22*/</span>,<br>DontUseThisTypeSession = <span class="hljs-number">35</span> <span class="hljs-comment">/*0x23*/</span>,<br>NonPagedPoolCacheAlignedSession = <span class="hljs-number">36</span> <span class="hljs-comment">/*0x24*/</span>,<br>PagedPoolCacheAlignedSession = <span class="hljs-number">37</span> <span class="hljs-comment">/*0x25*/</span>,<br>NonPagedPoolCacheAlignedMustSSession = <span class="hljs-number">38</span> <span class="hljs-comment">/*0x26*/</span><br>&#125; POOL_TYPE, *PPOOL_TYPE;<br></code></pre></td></tr></table></figure>
<p>pool-in-use在vista及之后版本是2，在xp和2003上是4</p>
<p>例,在win7上 使用中的paged pool chunk    </p>
<p>PoolType = PagedPool|2 = 3</p>
<p>如果chunk被free了并且加入ListHeads链表，poolheader下面就是LIST_ENTRY，因为这个原因，block size为8字节的chunk不被listheads维护，因为size不够放LIST_ENTRY。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">LIST_ENTRY</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x000*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">LIST_ENTRY</span>* <span class="hljs-title">Flink</span>;</span><br><span class="hljs-comment">/*0x004*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">LIST_ENTRY</span>* <span class="hljs-title">Blink</span>;</span><br>&#125; LIST_ENTRY, *PLIST_ENTRY;<br></code></pre></td></tr></table></figure>
<p>_LIST_ENTRY用于吧chunk加入双向链表。以前内存破坏类的漏洞利用不管是在用户态还是在内核态都是用类似的方法，”write-4” exploitation。简单来说就是覆盖list，然后可以达成任意地址分配内存，类似linux中的pwn。</p>
<p>对于小堆块，内核用lookaside单向链表来实现快速分配和释放 (LIFO方式)。这设计主要是用于cpu密集型，并用了原子操作来进行add和remove entries的操作。为了更好的使用cpu缓存lookaside lists在每个处理器的kpcrb中定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KPRCB</span></span><br><span class="hljs-class">&#123;</span><br>...<br><span class="hljs-comment">/*0x5A0*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">PP_LOOKASIDE_LIST</span> <span class="hljs-title">PPLookasideList</span>[16];</span><br><span class="hljs-comment">/*0x620*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">GENERAL_LOOKASIDE_POOL</span> <span class="hljs-title">PPNPagedLookasideList</span>[32];</span><br><span class="hljs-comment">/*0xF20*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">GENERAL_LOOKASIDE_POOL</span> <span class="hljs-title">PPPagedLookasideList</span>[32];</span><br>...<br>&#125; KPRCB, *PKPRCB;<br></code></pre></td></tr></table></figure>
<p>分页和非分页的lookaside list都在里面定义了。</p>
<p>固定且经常使用的大小会在PPLookasideList中，这是个特殊的专用的lookaside list</p>
<p>对于非分页和分页的lookaside lists，最大的块大小为0x20，因此每个类型的有32种。每个列表由GENERAL LOOKASIDE POOL 定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">GENERAL_LOOKASIDE_POOL</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x000*/</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">SLIST_HEADER</span> <span class="hljs-title">ListHead</span>;</span><br><span class="hljs-comment">/*0x000*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">SINGLE_LIST_ENTRY</span> <span class="hljs-title">SingleListHead</span>;</span><br>&#125;;<br><span class="hljs-comment">/*0x008*/</span> UINT16 Depth;<br><span class="hljs-comment">/*0x00A*/</span> UINT16 MaximumDepth;<br><span class="hljs-comment">/*0x00C*/</span> ULONG32 TotalAllocates;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x010*/</span> ULONG32 AllocateMisses;<br><span class="hljs-comment">/*0x010*/</span> ULONG32 AllocateHits;<br>&#125;;<br><span class="hljs-comment">/*0x014*/</span> ULONG32 TotalFrees;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x018*/</span> ULONG32 FreeMisses;<br><span class="hljs-comment">/*0x018*/</span> ULONG32 FreeHits;<br>&#125;;<br><span class="hljs-comment">/*0x01C*/</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> _<span class="hljs-title">POOL_TYPE</span> <span class="hljs-title">Type</span>;</span><br><span class="hljs-comment">/*0x020*/</span> ULONG32 Tag;<br><span class="hljs-comment">/*0x024*/</span> ULONG32 Size;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x028*/</span> PVOID AllocateEx;<br><span class="hljs-comment">/*0x028*/</span> PVOID Allocate;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x02C*/</span> PVOID FreeEx;<br><span class="hljs-comment">/*0x02C*/</span> PVOID Free;<br>&#125;;<br><span class="hljs-comment">/*0x030*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">LIST_ENTRY</span> <span class="hljs-title">ListEntry</span>;</span><br><span class="hljs-comment">/*0x038*/</span> ULONG32 LastTotalAllocates;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x03C*/</span> ULONG32 LastAllocateMisses;<br><span class="hljs-comment">/*0x03C*/</span> ULONG32 LastAllocateHits;<br>&#125;;<br><span class="hljs-comment">/*0x040*/</span> ULONG32 Future[<span class="hljs-number">2</span>];<br>&#125; GENERAL_LOOKASIDE_POOL, *PGENERAL_LOOKASIDE_POOL;<br><br></code></pre></td></tr></table></figure>
<p>SingleListHead.Next指向第一个被free的chunk，链表大小被Depth限制平衡管理器会定期调整，根据内存页的命中率，所以一个经常被访问的lookaside list的Depth值会很大，Depth初始值为4 (nt!ExMinimumLookasideDepth)，最大为256，如果lookaside list满了，pool chunk会被分配到合适的listheads里去。</p>
<p>session pool也有lookaside lists，paged session pool分配，使用单独的lookaside lists(nt!ExpSessionPoolLookaside)每个列表block size最大为0x19，由 nt!ExpSessionPoolSmallLists设置。session pool的lookaside list同样用了上述GENERAL LOOKASIDE POOL结构体，但是有了额外的填充。对于非分页的session pool，使用的lookaside lists和非分页内存的一样。</p>
<p>lookaside lists在hot/cold page separation pool flag 被设置为 (nt!ExpPoolFlags &amp; 0x100).会被禁用。</p>
<p>下面讲下large pool的分配。其实打过pwn的入门这玩意并没多大困难，很多思想都是一样的。</p>
<p>池描述符里的ListHeads维护的大小都小于一个页。当分配大小超过4080字节时会使用nt!ExpAllocateBigPool来处理，这和函数会继续调用nt!MiAllocatePoolPages,他将四舍五入计算size到最近的页大小。一个有着1 block size和0presize的large pool会被立刻分配。large pool分配完后，多余的内存会被插入到合适的池描述符ListHeads最后</p>
<p>关于numa</p>
<p><strong>非统一内存访问（NUMA）</strong>是一种用于多处理器的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%94%B5%E8%84%91">电脑</a>内存体设计，内存访问时间取决于处理器的内存位置。 在NUMA下，处理器访问它自己的本地存储器的速度比非本地存储器（存储器的地方到另一个处理器之间共享的处理器或存储器）快一些。</p>
<p>处理器和内存被分组在一个叫做节点的单元中，结构体定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KNODE</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x000*/</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">SLIST_HEADER</span> <span class="hljs-title">PagedPoolSListHead</span>;</span><br><span class="hljs-comment">/*0x008*/</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">SLIST_HEADER</span> <span class="hljs-title">NonPagedPoolSListHead</span>[3];</span><br><span class="hljs-comment">/*0x020*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">GROUP_AFFINITY</span> <span class="hljs-title">Affinity</span>;</span><br><span class="hljs-comment">/*0x02C*/</span> ULONG32 ProximityId;<br><span class="hljs-comment">/*0x030*/</span> UINT16 NodeNumber;<br><span class="hljs-comment">/*0x032*/</span> UINT16 PrimaryNodeNumber;<br><span class="hljs-comment">/*0x034*/</span> UINT8 MaximumProcessors;<br><span class="hljs-comment">/*0x035*/</span> UINT8 Color;<br><span class="hljs-comment">/*0x036*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">flags</span> <span class="hljs-title">Flags</span>;</span><br><span class="hljs-comment">/*0x037*/</span> UINT8 NodePad0;<br><span class="hljs-comment">/*0x038*/</span> ULONG32 Seed;<br><span class="hljs-comment">/*0x03C*/</span> ULONG32 MmShiftedColor;<br><span class="hljs-comment">/*0x040*/</span> ULONG32 FreeCount[<span class="hljs-number">2</span>];<br><span class="hljs-comment">/*0x048*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">CACHED_KSTACK_LIST</span> <span class="hljs-title">CachedKernelStacks</span>;</span><br><span class="hljs-comment">/*0x060*/</span> LONG32 ParkLock;<br><span class="hljs-comment">/*0x064*/</span> ULONG32 NodePad1;<br><span class="hljs-comment">/*0x068*/</span> UINT8 _PADDING0_[<span class="hljs-number">0x18</span>];<br>&#125; KNODE, *PKNODE;<br><br></code></pre></td></tr></table></figure>
<p>每个节点都由四个lookaside单向链表。这个链表主要服务于那些经常被访问的内存（计数器大）</p>
<p>对于分页内存，每个节点定义了一个lookaside list (PagedPoolSListHead) </p>
<p>对于非分页内存，定义了三个 (NonPagedPoolSListHead[3])</p>
<p>lookaside list的大小由系统的物理内存决定。</p>
<p>如果lookaside list不能用，就会使用比特位图allocation bitmap（RTL BITMAP），每个位都表示了当前大小的页是否在使用。</p>
<p>pagedpool中的bitmap在nt!MmPagedPoolInfo指向的MM_PAGED_POOL_INFO中定义</p>
<p>non-pagedpool中的bitmap在nt!MiNonPagedPoolBitMap指向结构体中定义</p>
<p>session pool的在MM_SESSION_SPACE结构体中定义。 </p>
<p>对于大多数large pool的分配 nt!ExAllocatePoolWithTag需要提供额外4字节(64位下是8字节)来存放size（位于pool body最后），当free时(ExFreePoolWithTag)该值会被检查来防止pool overflow。</p>
<h1 id="Allocation-Free-Algorithm"><a href="#Allocation-Free-Algorithm" class="headerlink" title="Allocation/Free Algorithm"></a>Allocation/Free Algorithm</h1><p>关于ExAllocatePoolWithTag</p>
<p><img src="image-20220312005121553.png" srcset="/img/loading.gif" lazyload alt="image-20220312005121553"></p>
<p>先访问lookaside lists没有就ListHeads lists如果还没有就会像分配器请求一个页.</p>
<p>如果是large pool，操作系统为了减少内存碎片，另一部分块取决于页面位置，如果页面对其，就会从前一个页来分配，否则从后面分配，无论是哪种方式，剩下的内存都会被放入ListHeads链表尾部。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">PVOID<br>ExAllocatePoolWithTag( POOL_TYPE PoolType,<br>SIZE_T NumberOfBytes,<br>ULONG Tag)<br><span class="hljs-comment">// call pool page allocator if size is above 4080 bytes</span><br><span class="hljs-keyword">if</span> (NumberOfBytes &gt; <span class="hljs-number">0xff0</span>) &#123;<br><span class="hljs-comment">// call nt!ExpAllocateBigPool</span><br>&#125;<br><span class="hljs-comment">// attempt to use lookaside lists</span><br><span class="hljs-keyword">if</span> (PoolType &amp; PagedPool) &#123;<br><span class="hljs-keyword">if</span> (PoolType &amp; SessionPool &amp;&amp; BlockSize &lt;= <span class="hljs-number">0x19</span>) &#123;<br><span class="hljs-comment">// try the session paged lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (BlockSize &lt;= <span class="hljs-number">0x20</span>) &#123;<br><span class="hljs-comment">// try the per-processor paged lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-comment">// lock paged pool descriptor (round robin or local node)</span><br>&#125;<br><span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// NonPagedPool</span><br><span class="hljs-keyword">if</span> (BlockSize &lt;= <span class="hljs-number">0x20</span>) &#123;<br><span class="hljs-comment">// try the per-processor non-paged lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-comment">// lock non-paged pool descriptor (local node)</span><br>&#125;<br><span class="hljs-comment">// attempt to use listheads lists</span><br><span class="hljs-keyword">for</span> (n = BlockSize<span class="hljs-number">-1</span>; n &lt; <span class="hljs-number">512</span>; n++) &#123;<br><span class="hljs-keyword">if</span> (ListHeads[n].Flink == &amp;ListHeads[n]) &#123; <span class="hljs-comment">// empty</span><br><span class="hljs-keyword">continue</span>; <span class="hljs-comment">// try next block size</span><br>&#125;<br><span class="hljs-comment">// safe unlink ListHeads[n].Flink</span><br><span class="hljs-comment">// split if larger than needed</span><br><span class="hljs-comment">// return chunk</span><br>&#125;<br><span class="hljs-comment">// no chunk found, call nt!MiAllocatePoolPages</span><br><span class="hljs-comment">// split page and return chunk</span><br></code></pre></td></tr></table></figure>
<p>关于ExFreePoolWithTag</p>
<p><img src="image-20220312005145088.png" srcset="/img/loading.gif" lazyload alt="image-20220312005145088"></p>
<p>主要操作是吧free的chunk放到正确的list中，同时操作系统为了减少内存碎片会判断周围的堆块是否空闲，如空闲进行合并操作。伪代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">VOID<br>ExFreePoolWithTag( PVOID Entry,<br>ULONG Tag)<br><span class="hljs-keyword">if</span> (PAGE_ALIGNED(Entry)) &#123;<br><span class="hljs-comment">// call nt!MiFreePoolPages</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-keyword">if</span> (Entry-&gt;BlockSize != NextEntry-&gt;PreviousSize)<br>BugCheckEx(BAD_POOL_HEADER);<br><span class="hljs-keyword">if</span> (Entry-&gt;PoolType &amp; SessionPagedPool &amp;&amp; Entry-&gt;BlockSize &lt;= <span class="hljs-number">0x19</span>) &#123;<br><span class="hljs-comment">// put in session pool lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Entry-&gt;BlockSize &lt;= <span class="hljs-number">0x20</span>) &#123;<br><span class="hljs-keyword">if</span> (Entry-&gt;PoolType &amp; PagedPool) &#123;<br><span class="hljs-comment">// put in per-processor paged lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br><span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// NonPagedPool</span><br><span class="hljs-comment">// put in per-processor non-paged lookaside list</span><br><span class="hljs-comment">// return on success</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (ExpPoolFlags &amp; DELAY_FREE) &#123; <span class="hljs-comment">// 0x200</span><br><span class="hljs-keyword">if</span> (PendingFreeDepth &gt;= <span class="hljs-number">0x20</span>) &#123;<br><span class="hljs-comment">// call nt!ExDeferredFreePool</span><br>&#125;<br><span class="hljs-comment">// add Entry to PendingFrees list</span><br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (IS_FREE(NextEntry) &amp;&amp; !PAGE_ALIGNED(NextEntry)) &#123;<br><span class="hljs-comment">// safe unlink next entry</span><br><span class="hljs-comment">// merge next with current chunk</span><br>&#125;<br><span class="hljs-keyword">if</span> (IS_FREE(PreviousEntry)) &#123;<br><span class="hljs-comment">// safe unlink previous entry</span><br><span class="hljs-comment">// merge previous with current chunk</span><br>&#125;<br><span class="hljs-keyword">if</span> (IS_FULL_PAGE(Entry))<br><span class="hljs-comment">// call nt!MiFreePoolPages</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// insert Entry to ListHeads[BlockSize - 1]</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>DELAY_FREE标志（nt!ExpPoolFlags &amp; 0x200）可以优化几个堆块的分配与释放。如果可用的物理内存(nt!MmNumberOfPhysicalPages)大于等于0x1fc00.每一次调用ExFreePoolWithTag都会要释放的堆块放到PendingFrees列表中，具体到每个池描述符。如果列表有32个或者更多的chunk(determined by PendingFreeDepth)，他将调用ExDeferredFreePool，这个函数会遍历然后把所有的chunk释放到适当的ListHeads列表中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">VOID<br>ExDeferredFreePool( PPOOL_DESCRIPTOR PoolDesc,<br>BOOLEAN bMultipleThreads)<br><span class="hljs-function"><span class="hljs-keyword">for</span> <span class="hljs-title">each</span> <span class="hljs-params">(Entry in PendingFrees)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (IS_FREE(NextEntry) &amp;&amp; !PAGE_ALIGNED(NextEntry)) &#123;<br><span class="hljs-comment">// safe unlink next entry</span><br><span class="hljs-comment">// merge next with current chunk</span><br>&#125;<br><span class="hljs-keyword">if</span> (IS_FREE(PreviousEntry)) &#123;<br><span class="hljs-comment">// safe unlink previous entry</span><br><span class="hljs-comment">// merge previous with current chunk</span><br>&#125;<br><span class="hljs-keyword">if</span> (IS_FULL_PAGE(Entry))<br><span class="hljs-comment">// add to full page list</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// insert Entry to ListHeads[BlockSize - 1]</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> each (page in full page <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-comment">// call nt!MiFreePoolPages</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>关于64位</p>
<p>//AMD64/x64 Kernel Pool Changes</p>
<p>除了支持更大的物理内存。64位下的windows kernel pool和32位并没有太大区别。</p>
<p>主要还是一些结构体成员大小的变化，如指针大小还有block size扩大到16字节计算方式同样改变</p>
<p>s BlockSize = (NumberOfBytes+0x1F) &gt;&gt; 4</p>
<p>对应的pool header也改变了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">POOL_HEADER</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x000*/</span> ULONG32 PreviousSize : <span class="hljs-number">8</span>;<br><span class="hljs-comment">/*0x000*/</span> ULONG32 PoolIndex : <span class="hljs-number">8</span>;<br><span class="hljs-comment">/*0x000*/</span> ULONG32 BlockSize : <span class="hljs-number">8</span>;<br><span class="hljs-comment">/*0x000*/</span> ULONG32 PoolType : <span class="hljs-number">8</span>;<br>&#125;;<br><span class="hljs-comment">/*0x000*/</span> ULONG32 Ulong1;<br>&#125;;<br><span class="hljs-comment">/*0x004*/</span> ULONG32 PoolTag;<br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x008*/</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EPROCESS</span>* <span class="hljs-title">ProcessBilled</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/*0x008*/</span> UINT16 AllocatorBackTraceIndex;<br><span class="hljs-comment">/*0x00A*/</span> UINT16 PoolTagHash;<br><span class="hljs-comment">/*0x00C*/</span> UINT8 _PADDING0_[<span class="hljs-number">0x4</span>];<br>&#125;;<br>&#125;;<br>&#125; POOL_HEADER, *PPOOL_HEADER;<br></code></pre></td></tr></table></figure>
<p>因为block size大小的改变，PreviousSize和BlockSize都减小到了8bits即1字节,ListHeads有256个双向链表数组而不是像x86上是512个。这也允许给PoolIndex额外分配一个比特位，因此64位下支持256节点(池描述符)，而不是像x86下的128个。另外pool header也扩大到16字节并且包括了ProcessBilled指针用于定位是那个进程使用的这个内存。在32位下这个指针存储与pool body的最后四个字节。</p>
<h1 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h1><p>内核池分配几种类型，都定义在POOL_TYPE中(Non-Paged Pools, Paged Pools, Session Pools, etc)</p>
<p>每种内核池都有一个描述符（POOL_DESCRIPTOR）用来记录分配/释放的块数目，正在使用中的页等等。还维护了一系列的chunks。</p>
<h2 id="Non-Paged-Pool"><a href="#Non-Paged-Pool" class="headerlink" title="Non-Paged Pool"></a>Non-Paged Pool</h2><p>非分页内存的数目被记录在nt!ExpNumberOfNonPagedPools，在单核操作系统中，nt!PoolVector的第一个下标指向了non-paged pool的描述符</p>
<p><code>kd&gt; dt nt!_POOL_DESCRIPTOR poi(nt!PoolVector)</code></p>
<p>在多核系统下每个核对应的node都有他自己的非分页内存描述符，由nt!ExpNonPagedPoolDescriptor数组里的指针指向。</p>
<h2 id="Paged-Pool"><a href="#Paged-Pool" class="headerlink" title="Paged Pool"></a>Paged Pool</h2><p>分页内存的数目被记录在nt!ExpNumberOfPagedPools，在单核操作系统中，4个paged pool描述符被定义在nt!ExpPagedPoolDescriptor的1至4下标（Index 1 through 4 in nt!ExpPagedPoolDescriptor）</p>
<p>在多核系统下每个核对应的node都有一个分页内存描述符</p>
<p>nt!ExpPagedPoolDescriptor下标为0处是额外的分页描述符为了定义prototype pools / full page allocations</p>
<h2 id="Session-Paged-Pool"><a href="#Session-Paged-Pool" class="headerlink" title="Session Paged Pool"></a>Session Paged Pool</h2><p>每个用户的都不一样，由nt!MiInitializeSessionPool来初始化。</p>
<p>win7下池描述符指向如下</p>
<p><code>KTHREAD-&gt;Process-&gt;Session.PagedPool</code></p>
<p>Non-paged session由全局的non-paged pool来分配</p>
<h2 id="Pool-Descriptor-Free-Lists-x86"><a href="#Pool-Descriptor-Free-Lists-x86" class="headerlink" title="Pool Descriptor Free Lists (x86)"></a>Pool Descriptor Free Lists (x86)</h2><p><img src="image-20220312131859710.png" srcset="/img/loading.gif" lazyload alt="image-20220312131859710"></p>
<p>这边一部分作者应该是写错了</p>
<p>照这个算法  (4080+0xf)&gt;&gt;3确实是511</p>
<p>但是8和24对应的下标应该是2和4而不是1，3.</p>
<p>这个0xf其实就是为了给header留空间并8字节对齐。</p>
<h2 id="Kernel-Pool-Header-x86"><a href="#Kernel-Pool-Header-x86" class="headerlink" title="Kernel Pool Header (x86)"></a>Kernel Pool Header (x86)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">kd&gt; dt nt!_POOL_HEADER<br> +<span class="hljs-number">0x000</span> PreviousSize : Pos <span class="hljs-number">0</span>, <span class="hljs-number">9</span> Bits<br> +<span class="hljs-number">0x000</span> PoolIndex : Pos <span class="hljs-number">9</span>, <span class="hljs-number">7</span> Bits<br> +<span class="hljs-number">0x002</span> BlockSize : Pos <span class="hljs-number">0</span>, <span class="hljs-number">9</span> Bits<br> +<span class="hljs-number">0x002</span> PoolType : Pos <span class="hljs-number">9</span>, <span class="hljs-number">7</span> Bits<br> +<span class="hljs-number">0x004</span> PoolTag : Uint4B<br></code></pre></td></tr></table></figure>
<p>PreviousSize:BlockSize of the preceding chunk</p>
<p>PoolIndex:Index into the associated pool descriptor array</p>
<p>BlockSize: (NumberOfBytes+0xF) &gt;&gt; 3</p>
<p>PoolType: Free=0, Allocated=(PoolType|2)</p>
<p>PoolTag: 4 printable characters identifying the code  responsible for the allocation</p>
<h2 id="Kernel-Pool-Header-x64"><a href="#Kernel-Pool-Header-x64" class="headerlink" title="Kernel Pool Header (x64)"></a>Kernel Pool Header (x64)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">kd&gt; dt nt!_POOL_HEADER<br> +<span class="hljs-number">0x000</span> PreviousSize : Pos <span class="hljs-number">0</span>, <span class="hljs-number">8</span> Bits<br> +<span class="hljs-number">0x000</span> PoolIndex : Pos <span class="hljs-number">8</span>, <span class="hljs-number">8</span> Bits<br> +<span class="hljs-number">0x000</span> BlockSize : Pos <span class="hljs-number">16</span>, <span class="hljs-number">8</span> Bits<br> +<span class="hljs-number">0x000</span> PoolType : Pos <span class="hljs-number">24</span>, <span class="hljs-number">8</span> Bits<br> +<span class="hljs-number">0x004</span> PoolTag : Uint4B<br> +<span class="hljs-number">0x008</span> ProcessBilled : Ptr64 _EPROCESS<br></code></pre></td></tr></table></figure>
<p>BlockSize: (NumberOfBytes+0x1F) &gt;&gt; 4</p>
<p>ProcessBilled: Pointer to process object charged for  the pool allocation (used in quota management)</p>
<p>64位变化就三个分别是BlockSize计算方式,多了个eprocess指向分配改内存的进程，256 ListHeads entries。</p>
<h2 id="Free-Pool-Chunks"><a href="#Free-Pool-Chunks" class="headerlink" title="Free Pool Chunks"></a>Free Pool Chunks</h2><p><img src="image-20220312134131427.png" srcset="/img/loading.gif" lazyload alt="image-20220312134131427"></p>
<h2 id="Lookaside-Lists"><a href="#Lookaside-Lists" class="headerlink" title="Lookaside Lists"></a>Lookaside Lists</h2><p>为了更快的分配/释放小内存</p>
<p><code>单向链表 LIFO</code></p>
<p><code>为性能做了优化 即没有检查</code></p>
<p>每个处理器都有他的lookaside lists(for pagable  and non-pagable allocations)</p>
<p><code>定义在KPCRB中</code></p>
<p><code>最大BlockSize是0x20即256字节</code></p>
<p><code>按照8字节递增，所以每种list有32个</code></p>
<p>这边的256字节是已经算上了head的256字节所以是0x20</p>
<p>GENERAL_LOOKASIDE_POOL定义了每个lookaside list</p>
<p><img src="image-20220312140627548.png" srcset="/img/loading.gif" lazyload alt="image-20220312140627548"></p>
<p>Session的忽略，暂不考虑。</p>
<h2 id="Large-Pool-Allocations"><a href="#Large-Pool-Allocations" class="headerlink" title="Large Pool Allocations"></a>Large Pool Allocations</h2><p>分配大小超过4080字节</p>
<p>由nt!ExpAllocateBigPool来处理</p>
<p><code>间接调用nt!MiAllocatePoolPages</code></p>
<p><code>请求的大小会被四舍五入到最接近页的大小</code></p>
<p><code>请求剩下的空闲块会被放到对应的池描述符的ListHeads链表里</code></p>
<p>每个处理器都有四个lookaside lists单向链表，为了big pool allocation而准备</p>
<p><code>1个是为了分页内存</code></p>
<p><code>3个是为非分页</code></p>
<p><code>都定义在KNODE (KPCR.PrcbData.ParentNode)中</code></p>
<p>如果lookaside lists被ban操作系统就会使用bitmap来获取需要的页</p>
<p><code>每个bit位都表示了正在使用的页</code></p>
<p><code>由RTL_BITMAP定义</code></p>
<p><img src="image-20220312151217350.png" srcset="/img/loading.gif" lazyload alt="image-20220312151217350"></p>
<h2 id="Allocation-Algorithm"><a href="#Allocation-Algorithm" class="headerlink" title="Allocation Algorithm"></a>Allocation Algorithm</h2><p>顺序如下</p>
<p>Lookaside list(s)  &gt;   ListHeads list(s)  &gt;  Pool page allocator</p>
<p>win7在取出一个free chunk后会进行unlink操作</p>
<p><img src="image-20220312153130972.png" srcset="/img/loading.gif" lazyload alt="image-20220312153130972"></p>
<p>简单来说就检查前一个chunk的flink和后一个chunk的blink是否正确指向了需要被ulink的chunk</p>
<p>伪代码如下这边直接贴原图了</p>
<p><img src="image-20220312153451750.png" srcset="/img/loading.gif" lazyload alt="image-20220312153451750"></p>
<p><img src="image-20220312153500233.png" srcset="/img/loading.gif" lazyload alt="image-20220312153500233"></p>
<p>如果从ListHeads[n]中返回的chunk大小比需求的大，就会进行分割。</p>
<p>如果是在页开头即prevsize=0的，那么就会返回chunk头部</p>
<p>否则返回尾部</p>
<p>剩下的chunk会放在ListHeads[n]的末尾</p>
<p><img src="image-20220312172719376.png" srcset="/img/loading.gif" lazyload alt="image-20220312172719376"></p>
<h2 id="Free-Algorithm"><a href="#Free-Algorithm" class="headerlink" title="Free Algorithm"></a>Free Algorithm</h2><p>free算法会检查pool header并把它释放到正确的list，为了减少内存碎片连续的free chunks可能会被合并。</p>
<p>ExFreePoolWithTag流程如下</p>
<p><img src="image-20220312172901824.png" srcset="/img/loading.gif" lazyload alt="image-20220312172901824"></p>
<p><img src="image-20220312172910202.png" srcset="/img/loading.gif" lazyload alt="image-20220312172910202"></p>
<p>合并流程如下</p>
<p><img src="image-20220312173044434.png" srcset="/img/loading.gif" lazyload alt="image-20220312173044434"></p>
<p>可以注意的是，free过程中如果chunk不在页开头回去检测next chunk的prevsize，当出现前几个字节不可控的池溢出时可以把chunk布局到页末尾来防止bsod。</p>
<h2 id="Delayed-Pool-Frees"><a href="#Delayed-Pool-Frees" class="headerlink" title="Delayed Pool Frees"></a>Delayed Pool Frees</h2><p>延迟释放机制是为了快速分配/释放而设计的</p>
<p>当MmNumberOfPhysicalPages &gt;= 0x1fc00就会启用</p>
<p><code>Equivalent to 508 MBs of RAM on IA-32 and AMD64</code></p>
<p><code>nt!ExpPoolFlags &amp; 0x200</code></p>
<p>每一次调用ExFreePoolWithTag都会在延迟释放链表（单向链表）中增加一个chunk</p>
<p><code>Current number of entries is given by PendingFreeDepth</code></p>
<p><code>The list is processed by the function ExDeferredFreePool if it  has 32 or more entries</code></p>
<p>函数流程如下</p>
<p><img src="image-20220312214235884.png" srcset="/img/loading.gif" lazyload alt="image-20220312214235884"></p>
<h1 id="ExAllocatePoolWithTag-x64"><a href="#ExAllocatePoolWithTag-x64" class="headerlink" title="ExAllocatePoolWithTag(x64)"></a>ExAllocatePoolWithTag(x64)</h1><p>ida7.5反编译的代码丑的一</p>
<p>有很多结构体还需要自己设置，最重要的还是最后的unlink实现，前面了解下逻辑就够了。</p>
<p><img src="image-20220313161741951.png" srcset="/img/loading.gif" lazyload alt="image-20220313161741951"></p>
<p>验证size是否&gt;0xfe0，32位下是ff0，因为俩个blocksize的算法不一样，64位下是bytes+0x1f，32位是+0xf所以这边验证是否大于0xfe0</p>
<p>然后判断是否按照页对其和大小是否超过一个页来进行对应的分配</p>
<p><img src="image-20220313162938437.png" srcset="/img/loading.gif" lazyload alt="image-20220313162938437"></p>
<p>然后判断pooltype是否为paged pool，计算blocksize来选择对应的lookaside lists</p>
<p><img src="image-20220313163045816.png" srcset="/img/loading.gif" lazyload alt="image-20220313163045816"></p>
<p>nonpagedpool情况如上</p>
<p>如果blocksize&gt;0x20</p>
<p>下面就会进行listheads遍历</p>
<p><img src="image-20220313164923505.png" srcset="/img/loading.gif" lazyload alt="image-20220313164923505"></p>
<p>关于safe unlink操作如下</p>
<p><img src="image-20220313165752682.png" srcset="/img/loading.gif" lazyload alt="image-20220313165752682"></p>
<p>unlink后会验证blocksize和待分配的是否相等是否页对齐来判断是否需要进行一个split entry操作</p>
<h1 id="ExFreePoolWithTag-x64"><a href="#ExFreePoolWithTag-x64" class="headerlink" title="ExFreePoolWithTag(x64)"></a>ExFreePoolWithTag(x64)</h1><p><img src="image-20220313182326244.png" srcset="/img/loading.gif" lazyload alt="image-20220313182326244"></p>
<p>判断nextchunk的prevsize是否与blocksize相等</p>
<p>下面是根据pooltype和blocksize来选择合适的lookaside list</p>
<p><img src="image-20220313182554224.png" srcset="/img/loading.gif" lazyload alt="image-20220313182554224"></p>
<p>然后是DELAY_FREE pool标志判断然后进行相应的操作</p>
<p><img src="image-20220313184205978.png" srcset="/img/loading.gif" lazyload alt="image-20220313184205978"></p>
<p>后面紧跟着的是merge操作</p>
<p><img src="image-20220313184352212.png" srcset="/img/loading.gif" lazyload alt="image-20220313184352212"></p>
<p>merge完后会判断是否为整页如果是的话直接调用MiFreePoolPages否则添加到listheads list中去</p>
<p><img src="image-20220313185239225.png" srcset="/img/loading.gif" lazyload alt="image-20220313185239225"></p>
<h1 id="Kernel-Pool-Attacks"><a href="#Kernel-Pool-Attacks" class="headerlink" title="Kernel Pool Attacks"></a>Kernel Pool Attacks</h1><p>下面讲解几种常用的攻击方式</p>
<h2 id="Traditional-ListEntry-Attacks-lt-Windows-7"><a href="#Traditional-ListEntry-Attacks-lt-Windows-7" class="headerlink" title="Traditional ListEntry Attacks (&lt; Windows 7)"></a>Traditional ListEntry Attacks (&lt; Windows 7)</h2><p>win7前在进行unlink时并不会进行check来验证flin和blink是否合规</p>
<p><img src="image-20220312230728966.png" srcset="/img/loading.gif" lazyload alt="image-20220312230728966"></p>
<p><img src="image-20220312230738585.png" srcset="/img/loading.gif" lazyload alt="image-20220312230738585"></p>
<p>上面俩种覆写ListHeads都可以间接修改chunk的大小，导致内存重叠，然后完全可控。</p>
<h2 id="ListEntry-Flink-Overwrite"><a href="#ListEntry-Flink-Overwrite" class="headerlink" title="ListEntry Flink Overwrite"></a>ListEntry Flink Overwrite</h2><p>win7使用了safe unlink来验证LIST_ENTRY的指针是否合规，但是他不会验证flink</p>
<p>构造一个chunk，这种利用对ListHeads[n]有要求就是chunk数目不小于2</p>
<p>//原因很简单，如果只有一个，在进行构造fakeentry后 listentry的blink不会改变，下一次过不了check</p>
<p>//为了防止蓝屏可以让指向的fakeentry的flink指向listentry本身，没试验过理论上应该可行</p>
<p><img src="image-20220312231425488.png" srcset="/img/loading.gif" lazyload alt="image-20220312231425488"></p>
<p>进行unlink后</p>
<p><strong>ListHeads[n].Flink</strong> = FakeEntry</p>
<p><strong>FakeEntry.Blink</strong> = ListHeads[n]</p>
<p>FakeEntry可控，利用方式就是写个用户态地址，这样下一次分配就会在我们可控的地址。</p>
<p><img src="image-20220312233606903.png" srcset="/img/loading.gif" lazyload alt="image-20220312233606903"></p>
<h2 id="Lookaside-Pointer-Overwrite"><a href="#Lookaside-Pointer-Overwrite" class="headerlink" title="Lookaside Pointer Overwrite"></a>Lookaside Pointer Overwrite</h2><p>chunk被放入lookaside lists条件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">BlockSize</span> &lt;= <span class="hljs-number">0</span>x<span class="hljs-number">20</span> for paged/non-paged pool chunks<br><span class="hljs-attribute">BlockSize</span> &lt;= <span class="hljs-number">0</span>x<span class="hljs-number">19</span> for paged session pool chunks<br><span class="hljs-attribute">Lookaside</span> list for target BlockSize is not full<br><span class="hljs-attribute">Hot</span>/cold page separation is not used<br></code></pre></td></tr></table></figure>
<p>因为lookasde lists是个单向链表，覆写就可以达到任意地址分配。</p>
<p><img src="image-20220313192704619.png" srcset="/img/loading.gif" lazyload alt="image-20220313192704619"></p>
<p>页被放入lookaside lists条件</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">NumberOfPages = <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> paged pool pages<br>NumberOfPages &lt;= <span class="hljs-number">3</span> <span class="hljs-keyword">for</span> non-paged pool pages<br>Lookaside list <span class="hljs-keyword">for</span> target page count <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">full</span><br>Size <span class="hljs-keyword">limit</span> determined <span class="hljs-keyword">by</span> physical page count <span class="hljs-keyword">in</span> <span class="hljs-keyword">system</span><br></code></pre></td></tr></table></figure>
<p>A pointer overwrite of lookaside pages requires at  most a pointer-wide overflow</p>
<p>因为free pool pages没有pool header</p>
<p><img src="image-20220313193149716.png" srcset="/img/loading.gif" lazyload alt="image-20220313193149716"></p>
<h2 id="PendingFrees-Pointer-Overwrite"><a href="#PendingFrees-Pointer-Overwrite" class="headerlink" title="PendingFrees Pointer Overwrite"></a>PendingFrees Pointer Overwrite</h2><p>延迟释放链表也是单向链表</p>
<p>和上一种攻击方式类似，覆写flink为用户态地址，用户态地址可控。</p>
<p>然后构造的fake chunk链表里next pointer必须是null来表明这个单向链表结束。</p>
<p><img src="image-20220313194116696.png" srcset="/img/loading.gif" lazyload alt="image-20220313194116696"></p>
<p>步骤</p>
<figure class="highlight irpf90"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs irpf90"><span class="hljs-keyword">Free</span> a chunk to the <span class="hljs-keyword">deferred</span> <span class="hljs-keyword">free</span> list<br>Overwrite the chunk’s next <span class="hljs-keyword">pointer</span><br> -Or <span class="hljs-built_in">any</span> of the <span class="hljs-keyword">deferred</span> <span class="hljs-keyword">free</span> list entries (<span class="hljs-number">32</span> <span class="hljs-keyword">in</span> total)<br>Trigger processing of the <span class="hljs-keyword">deferred</span> <span class="hljs-keyword">free</span> list<br> -Attacker controlled <span class="hljs-keyword">pointer</span> freed to designated <span class="hljs-keyword">free</span> list<br>Force allocation of the controlled list <span class="hljs-built_in">entry</span><br> -Allocator returns user-mode address<br>Corrupt <span class="hljs-built_in">allocated</span> <span class="hljs-built_in">entry</span><br>Trigger <span class="hljs-keyword">use</span> of corrupted <span class="hljs-built_in">entry</span><br></code></pre></td></tr></table></figure>
<h2 id="PoolIndex-Overwrite"><a href="#PoolIndex-Overwrite" class="headerlink" title="PoolIndex Overwrite"></a>PoolIndex Overwrite</h2><p>这个相对来说复杂了很多</p>
<p>PoolIndex代表了chunk在对应池描述符里的下标</p>
<p>打法需要借助0页，64位下已经不能了分配0页了，因为这个slides比较老11年的，这边就不写了。</p>
<h2 id="Quota-Process-Pointer-Overwrite"><a href="#Quota-Process-Pointer-Overwrite" class="headerlink" title="Quota Process Pointer Overwrite"></a>Quota Process Pointer Overwrite</h2><p>这种利用在实战的时候不经常用（我不常用，当然上报漏洞可以），除非数据完全可控，因为实战情况下往往不一定数据完全可控，会造成一定程度的内存破坏，需要进行修复，否则进程退出就蓝屏。</p>
<p>这种攻击方式可以达成任意地址减一。对修复不太友好。</p>
<p>利用方式很好理解，当chunk被free时会根据eprocess找到对应的引用技术进行-1操作。覆写eprocess为用户态地址即可，然后可达成任意地址-1，64位和32位有一些区别。</p>
<p><img src="image-20220313194940466.png" srcset="/img/loading.gif" lazyload alt="image-20220313194940466"></p>
<p>用户态伪造eprocess然后把EPROCESS_QUOTA_BLOCK处指向需要-1的地址</p>
<p><img src="image-20220313195113201.png" srcset="/img/loading.gif" lazyload alt="image-20220313195113201"></p>
<p>一般减1的地址会选择权限处，具体有点忘了，然后通过注入system权限进程启cmd达成提权。</p>
<h1 id="Summary-of-Attacks"><a href="#Summary-of-Attacks" class="headerlink" title="Summary of Attacks"></a>Summary of Attacks</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash">Corruption of busy pool chunk</span><br><span class="hljs-meta"> &gt;</span><span class="bash">BlockSize &lt;= 0x20</span><br><span class="hljs-meta">  &gt;</span><span class="bash">PoolIndex + PoolType/BlockSize Overwrite</span><br><span class="hljs-meta">  &gt;</span><span class="bash">Quota Process Pointer Overwrite</span><br><span class="hljs-meta"> &gt;</span><span class="bash">BlockSize &gt; 0x20</span><br><span class="hljs-meta">  &gt;</span><span class="bash">PoolIndex (+PoolType) Overwrite</span><br><span class="hljs-meta">  &gt;</span><span class="bash">Quota Process Pointer Overwrite</span><br><span class="hljs-meta">&gt;</span><span class="bash">Corruption of free pool chunk</span><br><span class="hljs-meta"> &gt;</span><span class="bash">BlockSize &lt;= 0x20</span><br><span class="hljs-meta">  &gt;</span><span class="bash">Lookaside Pointer Overwrite</span><br><span class="hljs-meta"> &gt;</span><span class="bash">BlockSize &gt; 0x20</span><br><span class="hljs-meta">  &gt;</span><span class="bash">ListEntry Flink Overwrite / PendingFrees Pointer Overwrite</span><br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/windows/">#windows</a>
      
        <a href="/tags/kernel/">#kernel</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>win7 kernel pool exploitation</div>
      <div>http://www.psbazx.com/2022/03/06/win7-kernel-pool-exploitation/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Beitragsautor</div>
          <div>皮三宝</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Veröffentlicht am</div>
          <div>March 6, 2022</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Urheberrechtshinweis</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/19/cve-2021-31956-win7-ver/" title="cve-2021-31956 win7 ver">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">cve-2021-31956 win7 ver</span>
                        <span class="visible-mobile">Vorheriger</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/27/%E5%88%86%E4%BA%AB%E4%B8%80%E6%B3%A2%E5%B7%A5%E4%BD%9C%E7%BB%8F%E5%8E%86/" title="分享一波工作经历">
                        <span class="hidden-mobile">分享一波工作经历</span>
                        <span class="visible-mobile">Nächster</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Inhaltsverzeichnis</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Suchen</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Stichwort</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog funktioniert am besten mit aktiviertem JavaScript</div>
  </noscript>
</body>
</html>
